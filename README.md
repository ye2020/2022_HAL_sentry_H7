# ACE2022  SENTRY_ H750 



--------------------------------------------------- 待测试或新增的功能 ------------------------------------------------------------

- [ ] H7还没测试左右漫反射传感器   
- [ ] 新增哨兵双云台代码
- [ ] 哨兵双云台独立电机测试
- [ ] 哨兵双云台装车测试
- [x] H7代码装车测试
- [x] H7代码与小电脑通信测试（ps：出现了问题，目前是用的串口加环形队列）
- [x] H7代码自瞄测试
- [x] 裁判系统接收代码
- [ ] 裁判系统接收测试
- [x] H7代码与小电脑通信优化（ps：指用DMA或开启cache等）
- [ ] 利用flash打印错误信息
- [x] 底盘随机运动代码
- [ ] 测试底盘随机运动



--------------------------------------------------  出现的问题 ----------------------------------------------------------------------



##### H7遥控串口一增加三极管反相后，DMA接收出现问题。存在接收不到的问题

- [ ] **原因：**感觉不是cache或数据一致性的问题，（都没开MPU）

- [ ] **解决：**遥控接收部分代码临时采用串口空闲中断加环形队列的方式（不完美，有出错的概率）



##### 用串口中断部分时候会出现接收错误（如，摇杆到一定的值的时候会出现，s1和s2拨杆突变为2 、2）

- [x] **原因：**用串口接收摇杆值出错概率大，在检测遥控数据正确性的时候会，把s1、s2置为`RC_SW_DOWN`（2）

- [x] **解决：**注释掉error里面的s1、s2的检测值（经测试，摇杆值未出现过错误）

- [ ] ```
  -  rc_ctrl.rc.s[0] = RC_SW_DOWN;
     rc_ctrl.rc.s[1] = RC_SW_DOWN;
  ```





##### 底盘电机遥控模式下出现剧烈抖动

- [x] **原因**：因为拨杆值的突变导致，状态转换表出现问题，状态机会短暂进入初始化状态机（STANDBY），进而清零电机的设定值，导致设定值突变造成抖动。
- [ ] **解决：**通过采用打补丁，限制突然出现的状态执行状态机的内容。用计数值。（治标不治本，可能还存在问题）



##### 电机出现突然的剧烈左右转动，发热，并且不受控

- [x] **原因**：直接原因：*电机运行过程中执行断点或退出debug，再加以扰动会出现这种情况*。
  - [ ] ​	根本原因：
- [ ] **解决：**尽量不在电机运行时加断点或退出（根除办法未知）



##### 用串口接环形队列接收发现有几个通道数据发生错误，其他正常

- [x] **原因：**串口奇偶校验导致，串口接收器需要开启奇偶校验，导致校验位==覆盖掉了最高位==而导致==接收数据错误==。
- [x] **解决：**在开启校验位时，将数据长度从8改为9

```
USART_InitStructure.USART_WordLength = USART_WordLength_9b;`    
```





##### H7 FREERTOS 跑飞进入硬件错误函数HardFault_Handler

- [x] **原因：**LED使用位带操作，未修改过地址偏移和映射，可能地址错误造成越界。
- [x] **原因2：**在板子选择初始化部分*`chassis_app_init（）`*和`gimbal_app_init（）`里添加操作系统的 延时函数`vTaskDelay（）`
- [x] **解决：**修改LED代码，不使用位带操作。



##### F4和H7 二合一代码用环形队列接收小电脑数据有问题

**描述：**用自己电脑上位机发送，板子能接收，数据正确。用两板通信，板子能接收，数据正确。用小电脑发送，则 能进空闲中断，但不接收数据。

- [x] **原因：**小电脑和板子没共地

- [x] **解决：**临时使用串口中断加环形队列的方式接收。（感觉小电脑用中断，遥控也用中断的话，会互相抢占线程。）

  （==在小电脑外部供电的时候，在TTl转串口上加一根线连接板子和TTL的GND==）



##### F4和H7 二合一代码用环形队列发送，数据一直在发送

- [x] **原因：**没注意，初始化DMA时用的是循环模式，又没有停下来的代码

- [x] **解决：**所有用到环形队列的串口，DMA配置为正常模式。





------------------------------------------------------- 踩的坑 ------------------------------------------------------------



- FDCAN的配置：（[具体见](D:\typora\stm32\STM32 H750 + FDCAN测试.md)）

- nor flash芯片配置：（[具体见](D:\typora\stm32\flash.md)）

  *1.要注意和硬件确认具体io口（搞死我）*

  *2.记得开启flash的时候留意一下 Printf 重定向的问题，没有的话会卡进程的（卡哪里忘记了）*

- 注意留意一下拨码开关的译码结果正不正常（感觉这玩意有点不耐造呐）

- 部分外设HAL库配置完记得==start一下==，（如：`HAL_TIM_PWM_Start(&htim1,TIM_CHANNEL_1);`）

- H7需要留意MPU和cache的问题，如果开启cache的话，需要注意数据一致性的问题。



